import{C as A,d as G,b as $,r as d,c as J,e as I,o,f as u,g as m,h as w,i as B,F as K,j as M,m as N,n as X,p as g,q as h,s as P,t as Y,_ as Z,u as ee}from"./index-BZUOWCTQ.js";const te=G({name:"FsCropperUploader",props:{disabled:{},modelValue:{type:[String,Array]},img:{},type:{type:String},uploadTip:{type:String},title:String,cropperHeight:{type:[String,Number]},dialogWidth:{type:[String,Number],default:"50%"},maxSize:{type:Number,default:5},limit:{type:Number,default:1},accept:{type:String,default:".jpg, .jpeg, .png, .gif, .webp"},cropper:{type:Object},uploader:{type:Object},compressQuality:{type:Number,default:.8},buildUrl:{type:Function,default:async function(e){return typeof e=="object"?e.url:e}},valueType:{type:String,default:"url"}},emits:["update:modelValue","change","ready"],setup(e,n){const{ui:b}=$(),f=d(),V=d(),C=d(),r=d([]),c=b.formItem.injectFormItemContext();let y=e.modelValue;l(e.modelValue);async function l(t){const a=[];if(t==null||t===""){r.value=a;return}if(typeof t=="string")a.push({url:await e.buildUrl(t),value:t,status:"done"});else for(const i of t)a.push({url:await e.buildUrl(i),value:i,status:"done"});r.value=a}function v(){e.disabled||(C.value=void 0,f.value.clear(),f.value.open())}function U(t){r.value.splice(t,1),x()}function _(){const t=r.value;if(t&&t.length>0){for(const a of t)if(a.status==="uploading")return!0}return!1}async function q(t){const a=t.blob,i=t.dataUrl,T=t.file.name,Q=new File([a],T,{type:a.type}),p=Y({url:void 0,dataUrl:i,status:"uploading",progress:0}),W=s=>{p.progress=s.percent},z=s=>{p.status="error",p.message="文件上传出错:"+s.message,console.error(s)},L={file:Q,onProgress:W,onError:z,fileName:T};r.value.push(p);try{const s=await j(L);let S=s;e.valueType!=="object"&&(S=s[e.valueType]),p.url=await e.buildUrl(S),p.value=S,p.status="done",x()}catch(s){z(s)}}async function j(t){t.options=e.uploader||{};const{getUploaderImpl:a}=Z();let i=await a(t.options.type);if(i==null)throw new Error("Sorry，The component is not ready yet");return await(i==null?void 0:i.upload(t))}async function x(){const t=[];for(const i of r.value)typeof i=="string"?t.push(i):t.push(i.value);let a=t;e.limit===1&&(a=t&&t.length>0?t[0]:void 0),y=a,n.emit("update:modelValue",a),await c.onChange(),await c.onBlur()}function F(t){return t.dataUrl?t.dataUrl:t.url}const k=d(!1),R=d();function D(t){k.value=!0,R.value=F(t)}function E(){k.value=!1,R.value=null}J(()=>e.modelValue,async t=>{n.emit("change",t),t!==y&&await l(t)});const H=ee();function O(t){n.emit("ready",{uploaderRef:H,...t})}return{ui:b,cropperRef:f,uploaderImplRef:V,indexRef:C,listRef:r,addNewImage:v,hasUploading:_,cropComplete:q,doUpload:j,removeImage:U,getImageSrc:F,previewUrl:R,previewVisible:k,preview:D,closePreview:E,doReady:O}}}),ae={class:"image-list"},le={class:"image-slot"},ie={class:"delete"},oe={key:0,class:"status-uploading"},re={key:1,class:"status-done"},se={class:"fs-cropper-preview-content"},ne=["src"];function ce(e,n,b,f,V,C){const r=I("fs-loading"),c=I("fs-icon"),y=I("fs-cropper");return o(),u("div",{class:P(["fs-cropper-uploader",{"is-disabled":e.disabled}])},[m("div",ae,[(o(),w(N(e.ui.imageGroup.name),null,{default:B(()=>[(o(!0),u(K,null,M(e.listRef,(l,v)=>(o(),u("div",{key:v,class:"image-item"},[(o(),w(N(e.ui.image.name),X({class:"image",src:e.getImageSrc(l)},e.img),{placeholder:B(()=>[m("div",le,[g(r,{loading:!0})])]),_:2},1040,["src"])),m("div",ie,[e.disabled?h("",!0):(o(),w(c,{key:0,icon:e.ui.icons.remove,onClick:U=>e.removeImage(v)},null,8,["icon","onClick"])),g(c,{icon:e.ui.icons.search,onClick:U=>e.preview(l)},null,8,["icon","onClick"])]),l.status==="uploading"?(o(),u("div",oe,[(o(),w(N(e.ui.progress.name),{type:"circle",percentage:l.progress,width:70},null,8,["percentage"]))])):l.status==="done"?(o(),u("div",re,[g(c,{icon:e.ui.icons.check,class:"status-down-icon"},null,8,["icon"])])):h("",!0)]))),128)),e.limit<=0||e.limit>e.listRef.length?(o(),u("div",{key:0,class:"image-item image-plus",onClick:n[0]||(n[0]=(...l)=>e.addNewImage&&e.addNewImage(...l))},[g(c,{icon:e.ui.icons.plus,class:"cropper-uploader-icon"},null,8,["icon"])])):h("",!0)]),_:1}))]),g(y,{ref:"cropperRef",title:e.title,"cropper-height":e.cropperHeight,"dialog-width":e.dialogWidth,accept:e.accept,"upload-tip":e.uploadTip,"max-size":e.maxSize,cropper:e.cropper,"compress-quality":e.compressQuality,output:"all",onDone:e.cropComplete,onReady:e.doReady},null,8,["title","cropper-height","dialog-width","accept","upload-tip","max-size","cropper","compress-quality","onDone","onReady"]),m("div",{class:P(["fs-cropper-preview",{open:e.previewVisible}]),onClick:n[1]||(n[1]=(...l)=>e.closePreview&&e.closePreview(...l))},[m("div",se,[e.previewUrl?(o(),u("img",{key:0,src:e.previewUrl,class:"preview-image"},null,8,ne)):h("",!0)])],2)],2)}const ue=A(te,[["render",ce]]);export{ue as default};
