import{C as fe,d as de,b as me,v as ye,r as y,x as w,c as we,o as g,f as ge,h as z,i as G,m as P,D as ve,E as he,n as K,g as be,q as xe,s as Le,l as v,G as Ue,_ as Te}from"./index-BZUOWCTQ.js";const Fe=de({name:"FsFileUploader",inheritAttrs:!1,props:{modelValue:{},limit:{type:Number},sizeLimit:{type:[Number,Object]},pixelLimit:{type:Object,required:!1},buildUrl:{default(){return o=>o}},buildUrls:{},button:{type:Object},listType:{type:String},beforeUpload:{type:Function},beforeUploadRequest:{type:Function},uploader:{type:Object},preview:{type:Object},valueType:{type:String,default:"url"},getFileName:{}},emits:["change","update:modelValue","success","exceed"],setup(o,n){const{ui:s}=me(),{t:c}=ye(),r=y([]),h=y(),f=y(),H=w(()=>o.getFileName||(async e=>{if(typeof e!="string")return console.warn("获取文件名失败，请配置getFileName"),e;const t=e.substring(e.lastIndexOf("/")+1),i=t.indexOf("?");return i>=0?t.substring(0,i):t}));function b(e){return o.valueType==="object"?e:e[o.valueType]}function J(e){const t=[];for(let i of e)t.push(b(i));return t}async function Q(e){const t=[];for(let i of e){let l;typeof i=="string"||typeof i=="number"||typeof i=="boolean"||i instanceof Date?(l={url:void 0,key:i,value:i},o.valueType!=="object"&&(l[o.valueType]=i)):l=i,l[s.upload.id]||(l[s.upload.id]=Math.random()+""),l.status||(l.status=s.upload.status.success),t.push(l)}await B(t);for(const i of t)if(!i.name){const l=i.url||i.value;i.name=await H.value(l)}return t}async function j(e){const t=[];for(let i of e){const l=i.response||i.fsRes,a={size:i.size,name:i.name,uid:i.uid,...l??i};t.push(a)}return await B(t),J(t)}async function x(e){const t=[];if(e==null||e.length===0){r.value=t;return}if(e instanceof Array)for(let l of e)t.push(l);else t.push(e);const i=await Q(t);q(i)}async function W(){await E.onChange(),await E.onBlur()}async function X(e){let t=await Y(e);V(t),Ue(async()=>{await W()})}async function Y(e){if(e==null||e.length===0)return o.limit===1?null:[];if(o.limit===1)return(await j(e))[0];const t=[];for(let i of e)s.upload.isSuccess(i)&&t.push(i);return await j(t)}async function B(e){let t=e.filter(i=>i.url==null);if(o.buildUrls){const i=t.map(a=>b(a)),l=await o.buildUrls(i);for(let a=0;a<t.length;a++)t[a].url=l[a]}else if(o.buildUrl)for(let i of t)i.url=await o.buildUrl(b(i));else for(let i of t)i.url=i.value||i.key}function I(e){n.emit("change",e)}function V(e){h.value=e,n.emit("update:modelValue",e)}const E=s.formItem.injectFormItemContext();we(()=>o.modelValue,async e=>{I(e),e!==h.value&&await x(e)}),x(o.modelValue);function Z(){return r.value.filter(e=>e.status===s.upload.status.uploading).length>0}function d(e,t){q(t),X(t)}function O(e,t,i){n.emit("success",{res:e,file:t,fileList:i}),d(t,i)}function S(e){let t;return e>1024*1024*1024?t=(e/(1024*1024*1024)).toFixed(2)+"G":e>1024*1024?t=(e/(1024*1024)).toFixed(2)+"M":t=Math.round(e/1024)+"K",t}const k=(e=!1)=>{const t=e?s.upload.limitAdd:0;return o.limit>0&&r.value.length>=o.limit+t};function $(){s.message.warn(c("fs.extends.fileUploader.limitTip",[o.limit]))}function L(){if(k(!0))throw $(),new Error("文件数量超限")}function ee(e){if(o.sizeLimit!=null){let t=o.sizeLimit,i=null;if(typeof o.sizeLimit=="number"?i=(l,a)=>{const p=S(a),u=S(e.size);s.message.warn(c("fs.extends.fileUploader.sizeLimitTip",[p,u]))}:(t=o.sizeLimit.limit,i=o.sizeLimit.tip),e.size>t)throw console.log("文件大小超过限制：",e.size),i(e.size,t),new Error("文件大小超过限制："+e.size)}}const te=e=>{let t=0,i=0,l="";if(o.pixelLimit)Array.isArray(o.pixelLimit)?(t=o.pixelLimit[0],i=o.pixelLimit[1]||o.pixelLimit[0]||0,l=o.pixelLimit[2]||""):typeof o.pixelLimit=="object"&&(t=o.pixelLimit.width||0,i=o.pixelLimit.height||0,l=o.pixelLimit.tip||"");else return Promise.resolve(!0);let a=l||c("fs.extends.fileUploader.pixelLimitTip",[t,i]);return new Promise((p,u)=>{let D=new FileReader;D.onload=pe=>{var _;let M=(_=pe.target)==null?void 0:_.result,m=new Image;m.onload=function(){t&&m.width>t||i&&m.height>i?(s.message.warn(a),u(a)):p(!0)},m.onerror=function(ze){s.message.warn(c("fs.extends.fileUploader.loadError")),u(c("fs.extends.fileUploader.loadError"))},M&&(m.src=M)},D.readAsDataURL(e)})},U=async(e,t=r.value)=>{if(!(o.beforeUpload&&await o.beforeUpload({file:e,fileList:r.value})===!1))try{L(),ee(e),F()&&await te(e)}catch{return!1}};function q(e){r.value=e}async function ie(e){e.options=o.uploader||{};const{getUploaderImpl:t}=Te();let i=await t(e.options.type);if(i==null)throw s.message.warn("Sorry，The uploader component is not ready yet"),new Error("Sorry，The component is not ready yet");return await(i==null?void 0:i.upload(e))}async function T(e){o.beforeUploadRequest&&await o.beforeUploadRequest(e);const{file:t,onProgress:i,onSuccess:l,onError:a}=e,p={file:t,fileName:t.name,onProgress:i};try{const u=await ie(p);l(u)}catch(u){console.error("上传失败",u),a(u)}}const oe=w(()=>ae()?{is:"FsIcon",icon:s.icons.plus}:{is:"FsButton",icon:s.icons.upload,text:c("fs.extends.fileUploader.text"),...o.button}),N=y(!1),A=y(),le=w(()=>({...s.dialog.footer(),...o.preview}));function se(e){return new Promise((t,i)=>{const l=new FileReader;l.readAsDataURL(e),l.onload=()=>t(l.result),l.onerror=a=>i(a)})}function F(){return o.listType===s.upload.typeImageCard||o.listType===s.upload.typeImage}function ae(){return o.listType===s.upload.typeImageCard}const R=async e=>{var t,i;if(!F()){let l;e.url?l=e.url:s.type==="antdv"?l=(t=e.response)==null?void 0:t.url:s.type==="element"?l=(i=e.fsRes)==null?void 0:i.url:l=e.url,window.open(l,"_blank")}!e.url&&!e.preview&&e.originFileObj&&(e.preview=await se(e.originFileObj)),A.value=e.url||e.preview,N.value=!0};function ne(){const e={customRequest:T,beforeUpload:U,listType:o.listType,onChange:t=>{const{file:i,fileList:l}=t;d(i,l)},onPreview:R};return o.limit!=null&&n.attrs.maxCount==null&&(e.maxCount=o.limit),e}function re(){return{action:"",listType:o.listType,beforeUpload:U,httpRequest:T,onExceed:()=>{L(),n.emit("exceed",{fileList:r.value})},onRemove:(e,t)=>{d(e,t)},onChange:(e,t)=>{d(e,t)},onSuccess:(e,t,i)=>{e!=null&&(t.response=e,t.fsRes=e,O(e,t,i))},onPreview:R}}const C={};function ue(){function e(t){let i=t.value||t;i=v.cloneDeep(i);for(let l of i){const a=C[l.id];a&&v.merge(l,a)}return i}return{action:"",listType:o.listType,onBeforeUpload:async({file:t,fileList:i})=>U(t,i),customRequest:t=>{const i=t.file;T({...t,file:i.file,onSuccess:async l=>{const a=o.valueType==="object"?l:l[o.valueType];l.url=await o.buildUrl(a),v.merge(i,l),C[i.id]={...l,fsRes:l},t.onFinish(i)},onProgress:l=>{t.onProgress(l)}})},onExceed:()=>{L(),n.emit("exceed",{fileList:r.value})},onRemove:t=>{},onChange:t=>{const{event:i,file:l,fileList:a}=t,p=e(a);d(l,[...p])},onFinish:t=>{const i=C[t.id];i&&v.merge(t,i);const l=e(r);O(i,t,l)},onPreview:R}}const ce=w(()=>{let e=null;return s.type==="antdv"?e=ne():s.type==="element"?e=re():e=ue(),{...e,...n.attrs}});return{ui:s,fileList:r,fileUploaderRef:f,initValue:x,onChange:I,onInput:V,hasUploading:Z,isPicture:F,computedFileSelectBtn:oe,previewVisible:N,previewImage:A,computedPreview:le,computedOnLimit:k,computedBinding:ce}}}),Re=["src"];function Ce(o,n,s,c,r,h){return g(),ge("div",{class:Le(["fs-file-uploader",{"fs-file-uploader-limit":o.computedOnLimit()}])},[(g(),z(P(o.ui.upload.name),K({ref:"fileUploaderRef",fileList:o.fileList,"onUpdate:fileList":n[0]||(n[0]=f=>o.fileList=f)},o.computedBinding),{default:G(()=>[(g(),z(P(o.computedFileSelectBtn.is),ve(he(o.computedFileSelectBtn)),null,16))]),_:1},16,["fileList"])),o.isPicture()?(g(),z(P(o.ui.dialog.name),K({key:0,[o.ui.dialog.visible]:o.previewVisible,["onUpdate:"+o.ui.dialog.visible]:n[1]||(n[1]=f=>o.previewVisible=f)},o.computedPreview),{default:G(()=>[be("img",{style:{"max-width":"100%","max-height":"100%"},src:o.previewImage},null,8,Re)]),_:1},16)):xe("",!0)],2)}const je=fe(Fe,[["render",Ce]]);export{je as default};
